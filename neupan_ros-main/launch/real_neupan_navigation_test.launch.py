#!/usr/bin/env python3

"""
çœŸå®çš„NeuPANå¯¼èˆªæµ‹è¯• - å®Œæ•´çš„å¯¼èˆªæ ˆæµ‹è¯•
"""

import os
from ament_index_python.packages import get_package_share_directory
from launch import LaunchDescription
from launch.actions import DeclareLaunchArgument, TimerAction, ExecuteProcess
from launch.conditions import IfCondition
from launch.substitutions import LaunchConfiguration
from launch_ros.actions import Node

def generate_launch_description():
    
    # Package directories
    neupan_ros_dir = get_package_share_directory('neupan_ros')
    
    # Configuration files
    rviz_config = os.path.join(neupan_ros_dir, 'rviz', 'simple_visual_test.rviz')
    
    # Launch arguments
    use_rviz = LaunchConfiguration('use_rviz')
    use_rviz_arg = DeclareLaunchArgument(
        'use_rviz',
        default_value='true',
        description='å¯åŠ¨RVizè¿›è¡Œå¯è§†åŒ–'
    )
    
    # å¯åŠ¨ä¿¡æ¯
    launch_info = ExecuteProcess(
        cmd=['echo', 'ğŸš€ å¯åŠ¨çœŸå®çš„NeuPANå¯¼èˆªæµ‹è¯•\\n' +\n                       'ğŸ“Š ç»„ä»¶åŒ…æ‹¬:\\n' +\n                       '  - æœºå™¨äººæ¨¡æ‹Ÿå™¨ (é‡Œç¨‹è®¡ + æ¿€å…‰é›·è¾¾)\\n' +\n                       '  - çœŸå®NeuPANæ§åˆ¶å™¨\\n' +\n                       '  - è·¯å¾„è§„åˆ’å™¨\\n' +\n                       '  - RVizå¯è§†åŒ–\\n' +\n                       '\\n' +\n                       'ğŸ¯ æµ‹è¯•æ­¥éª¤:\\n' +\n                       '  1. ç­‰å¾…æ‰€æœ‰ç»„ä»¶å¯åŠ¨\\n' +\n                       '  2. åœ¨RVizä¸­è®¾ç½®2D Nav Goal\\n' +\n                       '  3. è§‚å¯ŸNeuPANæ§åˆ¶å™¨çš„è·¯å¾„è·Ÿè¸ª\\n'],\n        output='screen'\n    )\n    \n    # 1. Static transforms\n    static_tf_odom_base = Node(\n        package='tf2_ros',\n        executable='static_transform_publisher',\n        name='static_tf_odom_base',\n        arguments=['0', '0', '0', '0', '0', '0', 'odom', 'base_link'],\n        output='screen'\n    )\n    \n    static_tf_base_laser = Node(\n        package='tf2_ros',\n        executable='static_transform_publisher',\n        name='static_tf_base_laser',\n        arguments=['0', '0', '0', '0', '0', '0', 'base_link', 'laser_frame'],\n        output='screen'\n    )\n    \n    # 2. Enhanced robot simulator (provides odometry and laser scan)\n    robot_simulator = Node(\n        package='neupan_ros',\n        executable='/home/robotmaster/ros2_ws/install/neupan_ros/bin/enhanced_robot_simulator',\n        name='enhanced_robot_simulator',\n        output='screen',\n        parameters=[{\n            'publish_rate': 20.0,\n            'robot_radius': 0.161,  # LIMOæœºå™¨äººåŠå¾„\n            'laser_range': 10.0,\n            'laser_angle_min': -3.14,\n            'laser_angle_max': 3.14,\n            'laser_angle_increment': 0.0087,  # 0.5åº¦\n            'environment_type': 'complex',  # å¤æ‚ç¯å¢ƒæµ‹è¯•\n            'enable_obstacles': True,\n        }]\n    )\n    \n    # 3. Path publisher (åˆ›å»ºæµ‹è¯•è·¯å¾„)\n    path_publisher = Node(\n        package='neupan_ros',\n        executable='/home/robotmaster/ros2_ws/install/neupan_ros/bin/simple_path_publisher',\n        name='path_publisher',\n        output='screen',\n        parameters=[{\n            'waypoints': [\n                0.0, 0.0, 0.0,      # èµ·ç‚¹\n                2.0, 0.0, 0.0,      # å‘å‰2ç±³\n                4.0, 0.0, 1.57,     # å‘å‰4ç±³å¹¶è½¬90åº¦\n                4.0, 2.0, 3.14,     # å‘ä¸Š2ç±³å¹¶è½¬180åº¦\n                2.0, 2.0, -1.57,    # å‘å·¦2ç±³å¹¶è½¬-90åº¦\n                0.0, 0.0, 0.0       # å›åˆ°èµ·ç‚¹\n            ]\n        }]\n    )\n    \n    # 4. çœŸå®çš„NeuPANæ§åˆ¶å™¨ (æ ¸å¿ƒç»„ä»¶)\n    neupan_controller = Node(\n        package='neupan_ros',\n        executable='/home/robotmaster/ros2_ws/install/neupan_ros/bin/real_neupan_controller',\n        name='real_neupan_controller',\n        output='screen',\n        parameters=[{\n            'use_sim_time': False,\n        }],\n        # è®¾ç½®ç¯å¢ƒå˜é‡\n        environment={'PYTHONPATH': '/home/robotmaster/ros2_ws/src/NeuPAN'}\n    )\n    \n    # 5. Goal publisher (ç›®æ ‡ç‚¹å¯è§†åŒ–)\n    goal_publisher = Node(\n        package='neupan_ros',\n        executable='/home/robotmaster/ros2_ws/install/neupan_ros/bin/goal_publisher_node',\n        name='goal_publisher_node',\n        output='screen',\n        parameters=[{\n            'goal_x': 4.0,\n            'goal_y': 2.0,\n            'goal_theta': 0.0\n        }]\n    )\n    \n    # 6. RViz for visualization  \n    rviz_node = Node(\n        package='rviz2',\n        executable='rviz2',\n        name='rviz2',\n        arguments=['-d', rviz_config],\n        condition=IfCondition(use_rviz),\n        output='screen'\n    )\n    \n    # 7. ç³»ç»ŸçŠ¶æ€ç›‘æ§å™¨\n    status_monitor = Node(\n        package='neupan_ros',\n        executable='python3',\n        name='status_monitor',\n        output='screen',\n        arguments=['-c', \n            '''\nimport rclpy\nfrom rclpy.node import Node\nfrom geometry_msgs.msg import Twist\nfrom nav_msgs.msg import Odometry, Path\nfrom sensor_msgs.msg import LaserScan\nimport time\n\nclass StatusMonitor(Node):\n    def __init__(self):\n        super().__init__(\"navigation_status_monitor\")\n        self.create_subscription(Twist, \"/cmd_vel\", self.vel_callback, 10)\n        self.create_subscription(Odometry, \"/odom\", self.odom_callback, 10)\n        self.create_subscription(Path, \"/path\", self.path_callback, 10)\n        self.create_subscription(LaserScan, \"/scan\", self.scan_callback, 10)\n        \n        self.last_print_time = time.time()\n        self.get_logger().info(\"ğŸ“Š å¯¼èˆªçŠ¶æ€ç›‘æ§å™¨å¯åŠ¨\")\n        \n    def vel_callback(self, msg):\n        current_time = time.time()\n        if current_time - self.last_print_time > 3.0:\n            self.get_logger().info(\n                f\"ğŸš— NeuPANè¾“å‡º: çº¿é€Ÿåº¦={msg.linear.x:.3f} m/s, è§’é€Ÿåº¦={msg.angular.z:.3f} rad/s\"\n            )\n            self.last_print_time = current_time\n    \n    def odom_callback(self, msg):\n        pass\n        \n    def path_callback(self, msg):\n        self.get_logger().info(f\"ğŸ“ æ¥æ”¶åˆ°è·¯å¾„ï¼ŒåŒ…å« {len(msg.poses)} ä¸ªç‚¹\")\n        \n    def scan_callback(self, msg):\n        pass\n\ndef main():\n    rclpy.init()\n    node = StatusMonitor()\n    rclpy.spin(node)\n\nif __name__ == \"__main__\":\n    main()\n            ''']\n    )\n    \n    return LaunchDescription([\n        use_rviz_arg,\n        \n        # å¯åŠ¨ä¿¡æ¯\n        launch_info,\n        \n        # åŸºç¡€TF\n        static_tf_odom_base,\n        static_tf_base_laser,\n        \n        # å»¶æ—¶å¯åŠ¨å„ä¸ªç»„ä»¶\n        TimerAction(\n            period=2.0,\n            actions=[robot_simulator]\n        ),\n        \n        TimerAction(\n            period=4.0,\n            actions=[path_publisher]\n        ),\n        \n        # å…³é”®: NeuPANæ§åˆ¶å™¨\n        TimerAction(\n            period=6.0,\n            actions=[neupan_controller]\n        ),\n        \n        TimerAction(\n            period=8.0,\n            actions=[goal_publisher, status_monitor]\n        ),\n        \n        # å¯è§†åŒ–\n        TimerAction(\n            period=10.0,\n            actions=[rviz_node]\n        ),\n    ])